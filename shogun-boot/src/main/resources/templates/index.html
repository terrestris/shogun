<!doctype html>
<!--
  SHOGun, https://terrestris.github.io/shogun/

  Copyright Â© 2020-present terrestris GmbH & Co. KG

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0.txt

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Static landing page for the SHOGun demo">
  <meta name="author" content="The SHOGun contributors">

  <link rel="shortcut icon" type="image/x-icon" href="./assets/img/favicon.ico">

  <title>SHOGun</title>

  <!-- Bootstrap 5.1.1  -->
  <link href="./assets/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <script src="./assets/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Font Awesome 5.15.4 -->
  <link href="./assets/lib/fontawesome/css/all.min.css" rel="stylesheet">
  <link href="./index.css" rel="stylesheet">
  <script th:src="${keycloakUrl + '/js/keycloak.js'}"></script>
</head>

<body>

  <header
    class="container d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
    <a href="/" class="d-flex align-items-center col-md-3 mb-2 mb-md-0 text-dark text-decoration-none">
      <img class="header-image" src="./assets/img/shogun_logo.png" alt="SHOGun logo">
    </a>
    <ul class="nav col-md-3">
      <li class="nav-item">
        <a href="#" class="nav-link px-2 text-muted" th:text="${'Version: ' + version}"></a>
      </li>
    </ul>
    <button id="login-btn" class="btn btn-primary">Log in</button>
    <button id="logout-btn" class="btn btn-primary" hidden>Log out</button>
  </header>

  <main>
    <!-- web component template starts -->
    <template id="shogun-app" url="">
      <link href="./assets/lib/fontawesome/css/all.min.css" rel="stylesheet">
      <div class="app-card">
        <div class="app-buttons">
          <slot name="admin-btn"></slot>
        </div>
        <div class="app-info">
          <h4>
            <slot name="app-title">Default Title</slot>
          </h4>
          <p>
            <slot name="app-info">description</slot>
          </p>
        </div>
      </div>
      <style>
        .app-card {
          border-radius: 10px;
          background-color: rgba(248, 249, 250, 1);
          height: auto;
          cursor: pointer;
        }

        .app-card:hover {
          background-color: rgba(233, 236, 239, 1);
        }

        .app-buttons {
          display: flex;
          justify-content: end;
          padding: 5px;
        }

        .app-info {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
        }
      </style>
    </template>
    <!-- web component template ends -->

    <div class="container px-4 py-5">
      <h2 class="pb-2">Welcome to SHOGun</h2>
      <a href="/admin">
        <button id="admin-panel-btn" class="btn btn-primary">
          Open Admin Panel <em class="fas fa-lock"></em>
        </button>
      </a>
      <h3 class="pb-2 pt-4">Applications</h3>
      <div class="row row-cols-1 row-cols-md-3 g-4 apps" />
    </div>

  </main>

  <footer class="container d-flex justify-content-between align-items-center py-3 my-4 border-top">
    <p class="col-md-4 mb-0 text-muted">
      &copy; 2021 - present <a href="https://www.terrestris.de">terrestris GmbH & Co. KG</a>
    </p>
    <p class="col-md-3 mb-0 text-muted">
      <em class="fas fa-plug"></em>
      <a href="./swagger-ui/index.html">Swagger / OpenAPI</a>
    </p>
    <p class="col-md-3 mb-0 text-muted">
      <em class="fas fa-project-diagram"></em>
      <a href="./graphiql">GraphiQL</a>
    </p>
    <p class="col-md-3 mb-0 text-muted">
      <em class="fab fa-github"></em>
      <a href="https://github.com/terrestris/shogun">GitHub</a>
    </p>
  </footer>

  <script th:inline="javascript">
    window.onload = async () => {
      const keycloak = new Keycloak({
        url: [[${keycloakUrl}]],
        realm: [[${keycloakRealm}]],
        clientId: [[${keycloakClientId}]]
      });
      try {
        const authenticated = await keycloak.init({
          onLoad: 'check-sso'
        });
      } catch (error) {
        console.error(error);
        return;
      }

      // Register login/logout actions
      document.querySelector('#login-btn').addEventListener('click', () => {
        keycloak.login();
      });
      document.querySelector('#logout-btn').addEventListener('click', () => {
        keycloak.logout();
      });
      if (keycloak.authenticated) {
        document.querySelector('#logout-btn').hidden = false;
        document.querySelector('#login-btn').hidden = true;
      }

      const applications = await getApplications(keycloak.token);
      const appInfos = applications.map(app => ({
        id: app.id,
        name: app.name,
        description: app.clientConfig && app.clientConfig.description
          ? app.clientConfig.description
          : ''
      }));
      const appsEl = document.querySelector('.apps');

      // Create web components
      customElements.define('shogun-app',
        class extends HTMLElement {
          constructor() {
            super();
            const template = document.querySelector('#shogun-app');
            const templateContent = template.content;

            this.attachShadow({ mode: 'open' }).appendChild(
              templateContent.cloneNode(true)
            );
          }
          connectedCallback() {
            this.onclick = () => window.open(`/client?applicationId=${this.getAttribute('app')}`);
          }
        });


      if (appsEl) {
        appInfos.forEach(app => {
          const html = `<shogun-app app='${app.id}'>` +
            `<a style='visibility: hidden' class='admin-btn' title='Edit application' slot='admin-btn' href='/admin/portal/application/${app.id}'>` +
            `<em class='fas fa-cog'></em></a>` +
            `<span slot='app-title'>${app.name}</span>` +
            `<span slot='app-info'>${app.description}</span>` +
            `</shogun-app>`;
          appsEl.insertAdjacentHTML('beforeend', html);
        });
      }

      // Check for admin role
      const hasAdminRole = keycloak.hasResourceRole('admin', 'shogun-admin');
      if (hasAdminRole) {
        document.querySelectorAll(".admin-btn").forEach(btn => {
          btn.style.visibility = 'visible';
          btn.addEventListener('click', (e) => e.stopPropagation());
        });
      };
    }

    const getApplications = async (token) => {
      try {
        const response = await fetch('/applications', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const applications = await response.json();
        if (applications && applications.content) {
          return applications.content;
        } else {
          throw new Error('Error while fetching applications');
        }
      } catch (error) {
        console.error(error);
      }
    }
  </script>
</body>

</html>
